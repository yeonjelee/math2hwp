import google.generativeai as genai
import os
import time
import re
from dotenv import load_dotenv
from PIL import Image
import streamlit as st
from google.api_core import exceptions

# ë¡œì»¬ í…ŒìŠ¤íŠ¸ìš© í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
load_dotenv()

def optimize_image(image):
    """
    ì´ë¯¸ì§€ ìµœì í™”: í‘ë°± ë³€í™˜ + ë¦¬ì‚¬ì´ì§• (í† í° ì ˆì•½)
    """
    img = image.convert('L') # í‘ë°±
    max_size = 1024
    width, height = img.size
    
    if max(width, height) > max_size:
        ratio = max_size / float(max(width, height))
        new_width = int(width * ratio)
        new_height = int(height * ratio)
        img = img.resize((new_width, new_height), Image.Resampling.LANCZOS)
    
    return img

# ğŸŒŸ íŒŒì´ì¬ ì •ê·œì‹ì„ í™œìš©í•œ í™•ì‹¤í•œ 'rm' í›„ì²˜ë¦¬ í•¨ìˆ˜ ğŸŒŸ
def apply_hwp_rm_rule(text):
    # HWP ìˆ˜ì‹ ì˜ˆì•½ì–´ (ëŒ€ë¬¸ìë¡œ ëœ ëª…ë ¹ì–´ë“¤ì€ rmì„ ë¶™ì´ë©´ ì•ˆ ë¨)
    reserved = {"LEFT", "RIGHT", "SUCC", "PREC", "GE", "LE", "OVER", "ROOT", "OF", "CDOT", "CDOTS"}
    
    # ì •ê·œì‹ ì„¤ëª…: ì•/ë’¤ì— ë‹¤ë¥¸ ì•ŒíŒŒë²³ì´ ì—†ëŠ” ëŒ€ë¬¸ì ë¬¶ìŒì„ ì°¾ìŒ. (ë‹¨, ì´ë¯¸ ì•ì— 'rm 'ì´ ìˆëŠ” ê²½ìš°ëŠ” ì œì™¸)
    pattern = r'(?<!rm )(?<![a-zA-Z])([A-Z]+)(?![a-zA-Z])'
    
    def repl(m):
        word = m.group(1)
        # ì˜ˆì•½ì–´ì¸ ê²½ìš° ê·¸ëŒ€ë¡œ ë°˜í™˜
        if word in reserved:
            return word
        # ì¼ë°˜ ëŒ€ë¬¸ì ë³€ìˆ˜(A, B, ABC ë“±)ì¸ ê²½ìš° ì•ì— 'rm 'ì„ ë¶™ì„
        return f"rm {word}"
        
    return re.sub(pattern, repl, text)

def get_hwp_conversion(image, doc_type, user_api_key=None):
    """
    gemini-flash-latest ëª¨ë¸ì„ ê°•ì œë¡œ ì‚¬ìš©í•˜ì—¬ HWP ìˆ˜ì‹ ë³€í™˜
    doc_typeì— ë”°ë¼ ì¶”ì¶œ ë‚´ìš© ë¶„ê¸° ì²˜ë¦¬
    """
    
    final_key = user_api_key
    if not final_key:
        final_key = os.getenv("GOOGLE_API_KEY")
        if not final_key:
            try:
                final_key = st.secrets["GOOGLE_API_KEY"]
            except:
                pass
    
    if not final_key:
        return "ğŸš« API í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤. ì‚¬ì´ë“œë°”ì—ì„œ í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."

    try:
        genai.configure(api_key=final_key)
        
        model = genai.GenerativeModel('gemini-flash-latest')
        
        optimized_img = optimize_image(image)
        
        # ë¬¸ì„œ ìœ í˜•ë³„ ì¶”ê°€ ì§€ì‹œì‚¬í•­
        if doc_type == "ë¬¸ì œ":
            doc_instruction = "í’€ì´ë‚˜ ì •ë‹µì€ ë¬´ì‹œí•˜ê³ , ê° ë¬¸ì œì˜ ì§€ë¬¸ê³¼ ìˆ˜ì‹ë§Œ ì¶”ì¶œí•˜ë¼."
        elif doc_type == "ìƒì„¸ í•´ì„¤":
            doc_instruction = "ê° ë¬¸ì œ ë²ˆí˜¸ì— í•´ë‹¹í•˜ëŠ” ìƒì„¸í•œ í’€ì´ ê³¼ì •(í•´ì„¤)ê³¼ ìˆ˜ì‹ì„ ì¶”ì¶œí•˜ë¼."
        else: # ë¹ ë¥¸ ì •ë‹µ
            doc_instruction = "ê° ë¬¸ì œ ë²ˆí˜¸ì™€ ê·¸ì— í•´ë‹¹í•˜ëŠ” ìµœì¢… ì •ë‹µë§Œ ì¶”ì¶œí•˜ë¼. ê¸´ í’€ì´ ê³¼ì •ì€ ìƒëµí•˜ë¼."

        # ğŸŒŸ í”„ë¡¬í”„íŠ¸ ì—…ë°ì´íŠ¸: ì‰¼í‘œ ë‚˜ì—´ ë¬¶ìŒ ê·œì¹™ ê°•ë ¥ ì¶”ê°€ ğŸŒŸ
        system_prompt = f"""
        ë„ˆëŠ” ëŒ€í•œë¯¼êµ­ ìˆ˜í•™ êµì¬ í¸ì§‘ ì „ë¬¸ê°€ë‹¤. 
        ì£¼ì–´ì§„ ì´ë¯¸ì§€ì—ì„œ **ì‹ë³„ ê°€ëŠ¥í•œ ëª¨ë“  ìˆ˜í•™ ë‚´ìš©**ì„ ì°¾ì•„ 'í•œê¸€(HWP) ìˆ˜ì‹ ìŠ¤í¬ë¦½íŠ¸'ë¡œ ë³€í™˜í•˜ë¼.
        
        [ì‘ì—… ì§€ì¹¨]
        1. ì´ë¯¸ì§€ì— ë³´ì´ëŠ” **ëª¨ë“  ë¬¸í•­/í•´ì„¤/ì •ë‹µ**ì„ ìˆœì„œëŒ€ë¡œ ë³€í™˜í•˜ë¼.
        2. ë¶ˆí•„ìš”í•œ ìš”ì†Œ(ìª½ë²ˆí˜¸ ë“±)ëŠ” ë¬´ì‹œí•˜ë¼.
        3. ë¬¸ì„œ ìœ í˜•: {doc_type}. {doc_instruction}

        [ì¶œë ¥ êµ¬ì¡° ê·œì¹™ - ğŸš¨ë§¤ìš° ì¤‘ìš”ğŸš¨]
        ê° í•­ëª©ì„ ì‹œì‘í•  ë•ŒëŠ” ë°˜ë“œì‹œ ë‹¤ìŒê³¼ ê°™ì´ ê³ ìœ í•œ ë²ˆí˜¸ êµ¬ë¶„ìë¡œ ì‹œì‘í•˜ë¼.
        ==== [ë¬¸ì œ ë²ˆí˜¸] ==== 
        (ì˜ˆ: ==== [0383] ====, ==== [1] ====)

        ğŸš¨ ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡(```text, ``` ë“±)ì€ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ê³ , ì˜¤ì§ 'ì¼ë°˜ í…ìŠ¤íŠ¸'ë¡œë§Œ ì¶œë ¥í•˜ë¼.
        ì§€ë¬¸(ë˜ëŠ” í•´ì„¤)ì„ ë¨¼ì € ì‘ì„±í•˜ê³ , ìˆ˜ì‹ì€ ë³¸ë¬¸ ì•„ë˜ì— [1], [2] ë“± ë²ˆí˜¸ë¥¼ ë§¤ê²¨ ë”°ë¡œ ë‚˜ì—´í•˜ë¼.
        
        ğŸš¨ [ìˆ˜ì‹ ë° ê¸°í˜¸ 100% ë¶„ë¦¬ ì›ì¹™]
        ë¬¸ì œë‚˜ í•´ì„¤ í…ìŠ¤íŠ¸ ë‚´ì— ì¡´ì¬í•˜ëŠ” **ëª¨ë“  ìˆ«ì, ì˜ì–´ ì•ŒíŒŒë²³, ìˆ˜í•™ ê¸°í˜¸, ìˆ˜ì‹**ì€ ë‹¨ í•˜ë‚˜ë„ ë¹ ì§ì—†ì´ 
        [1], [2] ì™€ ê°™ì´ ê¸°í˜¸ë¡œ ì¹˜í™˜í•˜ê³ , í•˜ë‹¨ì— HWP ìˆ˜ì‹ ìŠ¤í¬ë¦½íŠ¸ë¡œ ë”°ë¡œ ì‘ì„±í•˜ë¼.
        (ë³¸ë¬¸ í…ìŠ¤íŠ¸ì—ëŠ” ìˆœìˆ˜ í•œê¸€ë§Œ ë‚¨ì•„ìˆì–´ì•¼ í•œë‹¤.)
        
        ğŸš¨ [ì‰¼í‘œ(,) ë‚˜ì—´ ë¬¶ìŒ ê·œì¹™ - ë°˜ë“œì‹œ ì§€í‚¬ ê²ƒ!]
        ìˆ˜ì‹, ìˆ«ì, ê¸°í˜¸ê°€ ì‰¼í‘œ(,)ë¡œ ë‚˜ì—´ëœ ê²½ìš°(ì˜ˆ: A, B, C ë˜ëŠ” x=1, y=2 ë“±), ë³¸ë¬¸ì—ì„œ ì´ë¥¼ ì ˆëŒ€ ê°œë³„ì ìœ¼ë¡œ ìª¼ê°œì§€ ë§ê³  **ì „ì²´ë¥¼ ë¬¶ì–´ì„œ ë‹¨ì¼ ê¸°í˜¸(ì˜ˆ: [1])**ë¡œ ì¹˜í™˜í•˜ë¼.
        ê·¸ë¦¬ê³  í•˜ë‹¨ ìˆ˜ì‹ ìŠ¤í¬ë¦½íŠ¸ì— ì‘ì„±í•  ë•Œ ì‰¼í‘œ(,) ë’¤ì— ë°˜ë“œì‹œ ë¬¼ê²°í‘œ(~)ë¥¼ ë„£ì–´ ê°„ê²©ì„ ë„ì›Œë¼.
        (ì˜ëª»ëœ ì˜ˆì‹œ: ë³¸ë¬¸ "ë‘ ì  [1], [2], [3]ì—ì„œ" -> [1]: A ` / [2]: B ` / [3]: C ` )
        (ì˜¬ë°”ë¥¸ ì˜ˆì‹œ: ë³¸ë¬¸ "ë‘ ì  [1]ì—ì„œ" -> [1]: A,~B,~C ` )
        
        **ì¶œë ¥ í˜•íƒœ ì˜ˆì‹œ**
        ==== [0383] ====
        (ì§€ë¬¸ ë˜ëŠ” í•´ì„¤ ë‚´ìš©... ì‰¼í‘œë¡œ ë‚˜ì—´ëœ ê¸°í˜¸ëŠ” í•œ ë²ˆì— ë¬¶ì–´ì„œ [1]ë¡œ ì¹˜í™˜)
        
        [1]
        x=1,~y=2` 

        [2]
        5` 
        
        ---

        [HWP ìˆ˜ì‹ ë¬¸ë²• (ì ˆëŒ€ ì¤€ìˆ˜ ê·œì¹™)]
        1. **ëë§ºìŒ:** ëª¨ë“  ìˆ˜ì‹ ëì—ëŠ” ë°˜ë“œì‹œ ë°±í‹±(`)ì´ í•„ìˆ˜ë‹¤. (ì˜ˆ: y=x^2` )
        2. **ë‚˜ì—´ ë° ê°„ê²©:** ì—¬ëŸ¬ ìˆ˜ì‹ì´ë‚˜ ê¸°í˜¸ë¥¼ ë‚˜ì—´í•  ë•Œ ì‰¼í‘œ(,) ë’¤ì—ëŠ” ë°˜ë“œì‹œ ë¬¼ê²°í‘œ(~)ë¥¼ ì‚¬ìš©í•˜ì—¬ ê°„ê²©ì„ ë„ì›Œë¼. (ì˜ˆ: A,~B,~C / 1,~2,~cdots,~n)
        3. **ê´„í˜¸ ë¬¶ê¸°:** ì²¨ìë‚˜ ë¶„ëª¨/ë¶„ìê°€ ë‘ ê¸€ì ì´ìƒì¼ ê²½ìš° ë°˜ë“œì‹œ ì¤‘ê´„í˜¸ {{ }}ë¡œ ë¬¶ì–´ë¼. (ì˜ˆ: a_{{n+1}}, x^{{2n}})
        4. **ë¶„ìˆ˜ì™€ ê·¼í˜¸:** ë¶„ìˆ˜ëŠ” `{{ë¶„ì}} over {{ë¶„ëª¨}}`, ë£¨íŠ¸ëŠ” `root {{n}} of {{x}}` (ì œê³±ê·¼ì€ n ìƒëµ)
        5. **ì—°ì‚° ë° ëŒ€ì†Œ ê¸°í˜¸:**
           - í¬ë‹¤/ì‘ë‹¤: `SUCC`, `PREC`
           - í¬ê±°ë‚˜ ê°™ë‹¤ / ì‘ê±°ë‚˜ ê°™ë‹¤: `GE` / `LE`
           - ê°™ì§€ ì•Šë‹¤: `!=`
           - í”ŒëŸ¬ìŠ¤ë§ˆì´ë„ˆìŠ¤: `+-`
           - ì¤„ì„í‘œ(ì ì ì ): `cdots`
        6. **ë„í˜• ë° ê¸°í•˜:**
           - ì„ ë¶„: `overline {{AB}}`
           - ë²¡í„°: `vec {{v}}` ë˜ëŠ” `vec {{AB}}`
           - ì‚¼ê°í˜•: `triangle ABC`, ê°(`âˆ `): `angle A`
           - ê°ë„ì˜ ë„(Â°): ë°˜ë“œì‹œ ìˆ«ì ë’¤ì— `DEG`ë¥¼ ì‚¬ìš©í•˜ë¼. (ì˜ˆ: 30Â°, 90Â° -> 30 DEG, 90 DEG)
           - ìˆ˜ì§: `bot`, í‰í–‰: `//`
        7. **ì§‘í•© ë° ë…¼ë¦¬:**
           - ì›ì†Œì´ë‹¤/ì•„ë‹ˆë‹¤: `in` / `notin`
           - ë¶€ë¶„ì§‘í•©: `sub` (ë˜ëŠ” `subset`)
           - í•©ì§‘í•©/êµì§‘í•©: `cup` / `cap`
           - ê³µì§‘í•©: `empty`
           - ê·¸ëŸ¬ë¯€ë¡œ/ì™œëƒí•˜ë©´: `therefore` / `because`
        8. **ë¯¸ì ë¶„ ë° í•¨ìˆ˜:**
           - ê·¹í•œê³¼ ì‹œê·¸ë§ˆ: `lim _{{x -> a}}`, `sum _{{k=1}} ^{{n}}`
           - ì ë¶„: `int _{{a}} ^{{b}} f(x) dx`
           - ë¬´í•œëŒ€: `inf`
           - ì‚¼ê°/ë¡œê·¸ ë„ì–´ì“°ê¸°: log, sin, cos ë“±ì€ ë„ì–´ì“°ê¸° ëŒ€ì‹  ë°±í‹±(`) ì‚¬ìš©. (ì˜ˆ: log`5, sin`A)
        9. **ê·¸ë¦¬ìŠ¤ ë¬¸ì:** íŒŒì´(`pi`), ì„¸íƒ€(`theta`), ì•ŒíŒŒ(`alpha`), ë² íƒ€(`beta`) ë“±ì€ ì˜ë¬¸ ì†Œë¬¸ìë¡œ ê·¸ëŒ€ë¡œ ì‘ì„±í•˜ë¼.
        10. **ëŒ€ë¬¸ì ì•ŒíŒŒë²³:** ìˆ˜ì‹ ë‚´ì— ëŒ€ë¬¸ì ì•ŒíŒŒë²³(A, B, P ë“±)ì´ ë“¤ì–´ê°ˆ ê²½ìš°, ë°˜ë“œì‹œ ê¸€ì ì•ì— `rm `ì„ ë¶™ì—¬ë¼. (ì˜ˆ: rm A, rm B, rm P ë“±)
        """

        max_retries = 3
        for attempt in range(max_retries):
            try:
                response = model.generate_content([system_prompt, optimized_img])
                
                # ğŸŒŸ AIê°€ ë±‰ì–´ë‚¸ ê²°ê³¼ í…ìŠ¤íŠ¸ë¥¼ ë°›ì•„ì„œ íŒŒì´ì¬ ì½”ë“œë¡œ ëŒ€ë¬¸ì rm ê°•ì œ í›„ì²˜ë¦¬ ì ìš© ğŸŒŸ
                result_text = response.text
                final_processed_text = apply_hwp_rm_rule(result_text)
                
                return final_processed_text
            
            except exceptions.ResourceExhausted:
                time.sleep(5)
                continue
            except Exception as e:
                return f"ğŸš¨ ì˜¤ë¥˜ ë°œìƒ: {str(e)}"

        return "ğŸš« ì‚¬ìš©ëŸ‰ì´ ë§ì•„ ì ì‹œ ì œí•œë˜ì—ˆìŠµë‹ˆë‹¤. 1ë¶„ ë’¤ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."

    except Exception as e:
        return f"ğŸš¨ ì„¤ì • ì˜¤ë¥˜: {str(e)}"
